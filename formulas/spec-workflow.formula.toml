# Spec Workflow Formula
#
# Complete design-to-reviewed-spec pipeline in 4 steps:
#   Step 1: Multimodal scope questions (3x3 matrix analysis)
#   Step 2: Brainstorm (dialogue to validated spec)
#   Step 3: Questions interview (completeness check + fresh assessment)
#   Step 4: Multimodal review (3-model parallel review)
#
# Uses expansion composition to inline all workflow steps.
#
# Usage:
#   gt sling spec-workflow dypt/crew/neo \
#     --var feature="command-palette" \
#     --var brief="Add a keyboard-centric command palette for power users..."

description = """
Complete spec workflow from idea to reviewed design document.

Orchestrates 4 steps:
1. **Multimodal Scope Questions** - 3x3 matrix surfaces blind spots
2. **Brainstorm** - Smart dialogue turns questions into validated spec
3. **Questions Interview** - Completeness check + fresh eyes assessment
4. **Multimodal Review** - 3-model parallel review catches gaps

Steps 2 and 3 are interactive (user dialogue). Step 4 presents findings
and resolves issues interactively. Ends with a summary of all outputs.

Output: Fully reviewed spec at plans/{{feature}}/02-spec/spec.md

## Step Lifecycle (Molecule Work Loop)

This formula runs as a molecule — each step is a wisp bead. Use the
standard molecule work loop to advance through steps:

```bash
# 1. Find your current step:
bd mol current <molecule-id>

# 2. Execute the step (follow its instructions)

# 3. Close the step when done:
bd close <step-id>

# 4. Find the next step:
bd mol current <molecule-id>

# 5. Repeat until molecule complete
```

`bd mol current` returns the next ready step (open + all blocking deps
closed). Closing a step unblocks the next one in the dependency chain.

**Crash recovery:** Each `bd close` is durable. If your session crashes,
the next session runs `gt prime` which detects the molecule on your hook
and shows progress. `bd mol current` picks up at the next unclosed step.

Do NOT batch-close all steps at the end — close each one as you finish it.
"""
formula = "spec-workflow"
type = "workflow"
version = 6

[vars]
[vars.feature]
description = "Feature name (used for all input/output paths)"
required = true

[vars.brief]
description = "Feature brief or description (1-3 sentences describing what to build)"
required = true

# ============================================================================
# KICKOFF: Workflow banner
# ============================================================================

[[steps]]
id = "kickoff"
title = "Spec Workflow Kickoff"
description = """
═══════════════════════════════════════════════════════════════
 SPEC WORKFLOW
 Complete design pipeline from idea to reviewed spec.

 Steps:
  1. Multimodal Scope Questions — 3x3 matrix surfaces blind spots
  2. Brainstorm — smart dialogue to validated spec
  3. Questions Interview — two-pass completeness review
  4. Multimodal Review — three models review in parallel

 Input:  Feature name + brief description
 Output: Reviewed spec at plans/{feature}/02-spec/spec.md
═══════════════════════════════════════════════════════════════

Output this banner to the user, then close this step to begin.
"""

# ============================================================================
# STEP 1: MULTIMODAL SCOPE QUESTIONS (expanded from spec-scope-questions-expansion)
# ============================================================================

[[steps]]
id = "step-1-scope-questions"
title = "Step 1: Multimodal Scope Questions"
needs = ["kickoff"]
description = """
Surface design blind spots using a 3x3 matrix of models and perspectives.

This step is expanded into the full 3x3 matrix analysis:
1. Gather codebase context via Haiku
2. Dispatch 9 parallel analyses (3 models × 3 perspectives)
3. Consolidate per-model (3 parallel Haiku tasks)
4. Synthesize into prioritized question backlog (P0/P1/P2/P3)

**Outputs:**
- plans/{{feature}}/01-scope/context.md
- plans/{{feature}}/01-scope/questions.md (synthesized)
- Per-model question files
"""

# ============================================================================
# CHECKPOINT: After Scope Questions → before Brainstorm
# ============================================================================

[[steps]]
id = "checkpoint-after-scope"
title = "Context Checkpoint"
needs = ["step-1-scope-questions"]
description = """
## Context Checkpoint

Scope questions (Stage 1) is complete. Key artifacts produced:
- plans/{{feature}}/01-scope/context.md (codebase context)
- plans/{{feature}}/01-scope/questions.md (synthesized question backlog)
- Per-model question files from 3x3 matrix analysis

**If this is your first step in a fresh session**, close this step and continue.

**Otherwise**, cycle your context for the next phase:

1. Close this step: `bd close <step-id>`
2. Handoff: `gt handoff -s "Spec workflow: scope questions complete" -m "Scope questions generated via 3x3 matrix analysis. Questions backlog ready at plans/{{feature}}/01-scope/questions.md. Next: brainstorm phase — interactive dialogue to turn questions into validated spec."`

The next session picks up automatically at Brainstorm (Stage 2).
"""

# ============================================================================
# STEP 2: BRAINSTORM (expanded from spec-brainstorm-expansion)
# ============================================================================

[[steps]]
id = "step-2-brainstorm"
title = "Step 2: Brainstorm"
needs = ["checkpoint-after-scope"]
description = """
Turn scope questions into a validated design spec through smart dialogue.

This step is expanded into the full brainstorming workflow:
1. Load questions, present summary, ask user for scope
2. Triage: auto-answerable vs branch points
3. Dialogue: present auto-answers, walk through branch points
4. Write spec incrementally, validating each section

**Interactive:** This step involves dialogue with user for branch point decisions.

**Outputs:**
- plans/{{feature}}/01-scope/question-triage.md
- plans/{{feature}}/02-spec/spec.md
"""

# ============================================================================
# CHECKPOINT: After Brainstorm → before Questions Interview
# ============================================================================

[[steps]]
id = "checkpoint-after-brainstorm"
title = "Context Checkpoint"
needs = ["step-2-brainstorm"]
description = """
## Context Checkpoint

Brainstorm (Stage 2) is complete. Key artifacts produced:
- plans/{{feature}}/01-scope/question-triage.md (question triage)
- plans/{{feature}}/02-spec/spec.md (validated spec draft)

**If this is your first step in a fresh session**, close this step and continue.

**Otherwise**, cycle your context for the next phase:

1. Close this step: `bd close <step-id>`
2. Handoff: `gt handoff -s "Spec workflow: brainstorm complete" -m "Brainstorm complete — spec draft written at plans/{{feature}}/02-spec/spec.md with branch points decided. Next: questions interview for completeness check + fresh assessment, then multimodal review."`

The next session picks up automatically at Questions Interview (Stage 3).
"""

# ============================================================================
# STEP 3: QUESTIONS INTERVIEW (expanded from spec-questions-interview-expansion)
# ============================================================================

[[steps]]
id = "step-3-questions-interview"
title = "Step 3: Questions Interview"
needs = ["checkpoint-after-brainstorm"]
description = """
Review spec for gaps through completeness check + fresh assessment.

This step is expanded into the full interview workflow:
1. Load spec, triage, and context files
2. Completeness check against selected scope questions
3. Fresh assessment across 6 categories
4. Ask clarifying questions for any gaps (AskUserQuestion)
5. Update spec with clarifications

**Interactive:** May ask clarifying questions if gaps found.

**Outputs:**
- Updated plans/{{feature}}/02-spec/spec.md with "Spec Review" section
"""

# ============================================================================
# STEP 4: MULTIMODAL REVIEW (expanded from spec-multimodal-review-expansion)
# ============================================================================

[[steps]]
id = "step-4-multimodal-review"
title = "Step 4: Multimodal Review"
needs = ["step-3-questions-interview"]
description = """
3-model parallel review catches remaining gaps and inconsistencies.

This step is expanded into the full multimodal review workflow:
1. Reuse context.md from Step 1
2. Dispatch 3 models in parallel (all 12 review categories)
3. Synthesize: comparison table, issues by severity, ambiguities
4. Present findings, gate on "go"
5. Action: select issues, resolve ambiguities, update spec

**Outputs:**
- plans/{{feature}}/02-spec/spec-review.md
- Updated plans/{{feature}}/02-spec/spec.md with "Multi-Model Review" section
"""

# ============================================================================
# COMPLETE: Summary
# ============================================================================

[[steps]]
id = "complete"
title = "Workflow Complete"
needs = ["step-4-multimodal-review"]
description = """
Spec workflow is complete.

**Summary:**
- Step 1: Scope questions generated (3-model consensus)
- Step 2: Spec written (branch points decided)
- Step 3: Interview completed (gaps addressed)
- Step 4: Multimodal review completed (issues resolved)

**Final outputs:**
- plans/{{feature}}/02-spec/spec.md (reviewed spec)
- plans/{{feature}}/02-spec/spec-review.md (review findings)
- plans/{{feature}}/01-scope/ (analysis artifacts)
- plans/{{feature}}/01-scope/question-triage.md (triage record)

**Next steps:**
- Run plan-workflow to produce a reviewed implementation plan from this spec
- Run beads-workflow to convert the plan into a verified beads issue hierarchy
- Run epic-delivery to dispatch the beads to polecats for implementation
"""

# ============================================================================
# COMPOSITION: Expand placeholder steps with expansion formulas
# ============================================================================

[compose]

[[compose.expand]]
target = "step-1-scope-questions"
with = "spec-multimodal-scope-questions-expansion"

[[compose.expand]]
target = "step-2-brainstorm"
with = "spec-brainstorm-expansion"

[[compose.expand]]
target = "step-3-questions-interview"
with = "spec-questions-interview-expansion"

[[compose.expand]]
target = "step-4-multimodal-review"
with = "spec-multimodal-review-expansion"
