# Blocker Escalation Formula
#
# Structured workflow for Gas Town workers when a task is blocked and
# asynchronous escalation is required.
#
# Usage:
#   gt sling mol-blocker-escalation toolkit/polecats/furiosa \
#     --var issue="to-abc123" \
#     --var blocker_summary="Integration tests fail with missing credentials"

description = """
Handle blockers with a repeatable, auditable Gas Town workflow.

This formula helps a worker:
1. Capture evidence and verify the blocker is real
2. Route ownership to the correct rig
3. Make bounded local recovery attempts
4. File follow-up beads for newly discovered work
5. Escalate asynchronously (without waiting for live human responses)
6. Choose continuation, handoff, or escalated exit

Use this when progress is blocked by unclear requirements, external dependencies,
infra failures, missing access, or cross-rig ownership boundaries.
"""
formula = "mol-blocker-escalation"
type = "workflow"
version = 1

[vars]
[vars.issue]
description = "Current work item (bead ID) that is blocked"
required = true

[vars.blocker_summary]
description = "One-line blocker summary for escalation messages"
required = true

[vars.severity]
description = "Escalation severity to use (LOW, MEDIUM, HIGH, CRITICAL)"
required = false

[[steps]]
id = "capture-evidence"
title = "Capture blocker evidence"
description = """
Document concrete evidence before escalating.

Run:
```bash
bd show {{issue}}
git status
```

Capture:
- Exact failing command(s)
- Error output and timestamps
- What changed immediately before the failure
- What scope is currently blocked

Success criteria:
- You can describe the blocker in 2-3 factual sentences
- You have at least one reproducible failing command or observation
"""

[[steps]]
id = "classify-ownership"
title = "Classify ownership and routing"
needs = ["capture-evidence"]
description = """
Determine where the fix belongs before creating follow-up work.

Rule: file issues in the rig that owns the code where the fix would be committed.

Common routing:
- This rig's repo -> `bd create ...` (current rig)
- Beads CLI behavior -> `bd create --rig beads ...`
- Gas Town CLI / runtime behavior -> `bd create --rig gastown ...`
- Cross-rig coordination -> `bd create --prefix hq- ...`

Success criteria:
- You know the destination rig/prefix for follow-up issue filing
"""

[[steps]]
id = "bounded-recovery"
title = "Attempt bounded local recovery"
needs = ["classify-ownership"]
description = """
Attempt quick, bounded recovery before escalating.

Time box:
- 2 attempts max
- <= 15 minutes per attempt

Examples:
- Re-run with fresh context (`gt prime`)
- Verify hook/workflow state (`gt hook`, `bd ready`)
- Re-check assumptions against docs/code
- Retry failing command with minimal repro

If recovery succeeds:
- Return to normal execution on `{{issue}}`

If recovery fails:
- Continue to follow-up issue filing and escalation
"""

[[steps]]
id = "file-follow-up"
title = "File follow-up beads for discovered work"
needs = ["bounded-recovery"]
description = """
Create explicit tracked work for what you discovered.

Examples:
```bash
bd create --title "Blocker: {{blocker_summary}}" --type bug
bd create --rig gastown --title "Blocker in gt CLI: {{blocker_summary}}" --type bug
bd create --prefix hq- --title "Cross-rig unblock needed: {{blocker_summary}}" --type task
```

Include:
- Symptoms and reproduction steps
- What you already tried
- Impact on current issue (`{{issue}}`)

Success criteria:
- At least one follow-up bead exists when a real external blocker was found
"""

[[steps]]
id = "escalate"
title = "Escalate asynchronously"
needs = ["file-follow-up"]
description = """
Escalate without waiting for synchronous approval.

Preferred:
```bash
gt escalate "{{blocker_summary}}" -s HIGH -m "Issue: {{issue}}
Blocker: {{blocker_summary}}
Tried: <attempt 1>; <attempt 2>
Follow-up: <new-bead-id(s)>
Need: <decision, access, or owner action>"
```

Also notify witness when useful:
```bash
gt mail send toolkit/witness -s "BLOCKED: {{issue}}" -m "Blocker: {{blocker_summary}}
Escalation: sent
Follow-up: <new-bead-id(s)>"
```

Success criteria:
- Escalation message sent with actionable next-step ask
- Relevant parties are notified with bead references
"""

[[steps]]
id = "gate-next-action"
title = "Gate: choose continuation path"
needs = ["escalate"]
gate = { type = "human" }
description = """
Decide the next path based on blocker severity and available parallel work.

Options:
1. Blocker resolved -> return to `{{issue}}` implementation
2. Still blocked but alternate work exists -> switch tasks and continue
3. Fully blocked -> handoff context or exit escalated

Commands:
```bash
gt handoff -s "Blocked on {{issue}}" -m "Blocker: {{blocker_summary}}
Escalation: <link or id>
Follow-up beads: <ids>
Next: <what the next session should do>"
```

or

```bash
gt done --status=ESCALATED
```
"""

[[steps]]
id = "complete"
title = "Blocker workflow complete"
needs = ["gate-next-action"]
description = """
Blocker handling is complete.

Checklist:
- Evidence captured
- Ownership routed correctly
- Recovery attempts made (bounded)
- Follow-up work filed
- Escalation sent
- Next action chosen (continue, handoff, or escalated done)
"""
